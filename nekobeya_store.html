<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœ€å¯„ã‚Šåº—èˆ—æ¤œç´¢</title>
    <style>
        :root {
            --primary-color: #007bff; /* é’ç³»ã«å¤‰æ›´ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ©ã‚¤ã‚¯ã«ï¼‰ */
            --primary-dark: #0056b3;
            --accent-color: #ffc107;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px 10px;
            line-height: 1.5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 22px;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        /* æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  */
        .search-box {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="text"] {
            width: 100%;
            padding: 14px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: #fafafa;
            margin-bottom: 15px;
        }

        button.search-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        button.search-btn:hover { background-color: var(--primary-dark); }
        button.search-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* çµæœãƒªã‚¹ãƒˆ */
        #results-area { display: none; }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #666;
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
        }

        .store-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            position: relative;
            animation: fadeIn 0.5s ease;
        }

        /* ç¾½ç”°ç©ºæ¸¯åº—å¼·èª¿ç”¨ */
        .store-card.highlight {
            border: 2px solid var(--accent-color);
            background-color: #fffdf5;
        }
        .badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-color);
            color: #333;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .store-name {
            font-size: 18px;
            font-weight: bold;
            margin: 0 0 5px 0;
            color: #333;
        }
        .store-address {
            font-size: 12px;
            color: #888;
            margin-bottom: 12px;
        }

        .routes-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            border-top: 1px dashed #eee;
            padding-top: 10px;
        }

        .route-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 13px;
        }
        
        .route-icon { font-size: 20px; margin-bottom: 2px; }
        .route-time { font-weight: bold; font-size: 16px; color: var(--primary-dark); }
        .route-dist { font-size: 11px; color: #666; }
        .no-route { color: #aaa; font-size: 12px; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* èª­ã¿è¾¼ã¿ä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .pac-container { z-index: 1000; border-radius: 8px; margin-top: 2px; }
    </style>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCH7MD4Jj8pKU9hDSJUYqBgq8fQsMWWDjE&libraries=places"></script>
</head>
<body>

<div class="container">
    <h1>ğŸ“ æœ€å¯„ã‚Šåº—èˆ—ãƒ»æ‰€è¦æ™‚é–“æ¤œç´¢</h1>

    <div class="search-box">
        <label for="user-address">ã‚ãªãŸã®ä½æ‰€</label>
        <input type="text" id="user-address" placeholder="ä¾‹ï¼šæ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿ï¼’ä¸ç›®ï¼˜âˆ’ï¼‘">
        <button class="search-btn" onclick="searchStores()">æ¤œç´¢ã™ã‚‹</button>
        <div id="loader" class="loader"></div>
    </div>

    <div id="results-area">
        <div class="section-title">è¿‘ã„é † TOP 5 (+ ç¾½ç”°ç©ºæ¸¯åº—)</div>
        <div id="cards-container"></div>
    </div>
</div>

<script>
    // åº—èˆ—ãƒ‡ãƒ¼ã‚¿å®šç¾©
    const STORES = [
        { id: 'minato', name: 'ã­ã“ã¹ã‚„æ¸¯åŒºæœ¬åº—', address: 'æ±äº¬éƒ½æ¸¯åŒºèŠ3ä¸ç›®13-5' },
        { id: 'haneda', name: 'ã­ã“ã¹ã‚„ç¾½ç”°ç©ºæ¸¯åº—', address: 'æ±äº¬éƒ½å¤§ç”°åŒºç¾½ç”°1-8-4' }, // â€»å¿…é ˆè¡¨ç¤º
        { id: 'suginami', name: 'ã­ã“ã¹ã‚„æ‰ä¸¦åº—', address: 'æ±äº¬éƒ½æ‰ä¸¦åŒºå®®å‰4ä¸ç›®25-28' },
        { id: 'musashino', name: 'ã­ã“ã¹ã‚„æ­¦è”µé‡åº—', address: 'æ±äº¬éƒ½æ­¦è”µé‡å¸‚é–¢å‰4-11-25' },
        { id: 'edogawa', name: 'ã­ã“ã¹ã‚„æ±Ÿæˆ¸å·åº—', address: 'æ±äº¬éƒ½æ±Ÿæˆ¸å·åŒºæ–°å €1ä¸ç›®24-1' }
    ];

    let distanceMatrixService;

    function initMap() {
        // ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã®è¨­å®š
        const input = document.getElementById("user-address");
        const options = {
            componentRestrictions: { country: "jp" },
            fields: ["formatted_address", "geometry", "name"],
        };
        new google.maps.places.Autocomplete(input, options);

        // è·é›¢è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–
        distanceMatrixService = new google.maps.DistanceMatrixService();
    }

    // APIãƒ­ãƒ¼ãƒ‰å®Œäº†æ™‚ã«å®Ÿè¡Œ
    window.onload = initMap;

    async function searchStores() {
        const userAddress = document.getElementById("user-address").value;
        if (!userAddress) {
            alert("ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        // UIåˆ¶å¾¡
        document.querySelector('.search-btn').disabled = true;
        document.getElementById('loader').style.display = 'block';
        document.getElementById('results-area').style.display = 'none';
        document.getElementById('cards-container').innerHTML = '';

        try {
            // åº—èˆ—ã®ä½æ‰€ãƒªã‚¹ãƒˆã‚’ä½œæˆ
            const destinations = STORES.map(store => store.address);

            // 1. è»Šã§ã®è¨ˆç®— (DRIVING)
            const drivingPromise = getDistanceMatrix(userAddress, destinations, 'DRIVING');
            
            // 2. å…¬å…±äº¤é€šæ©Ÿé–¢ã§ã®è¨ˆç®— (TRANSIT)
            const transitPromise = getDistanceMatrix(userAddress, destinations, 'TRANSIT');

            // ä¸¦è¡Œã—ã¦å®Ÿè¡Œã—ã¦å¾…ã¤
            const [drivingResults, transitResults] = await Promise.all([drivingPromise, transitResults]);

            // çµæœã‚’çµåˆã—ã¦æ•´å½¢
            let calculatedStores = STORES.map((store, index) => {
                const dRes = drivingResults.rows[0].elements[index];
                const tRes = transitResults.rows[0].elements[index];

                return {
                    ...store,
                    driving: {
                        status: dRes.status,
                        text: dRes.duration ? dRes.duration.text : '--',
                        value: dRes.duration ? dRes.duration.value : 9999999, // ã‚½ãƒ¼ãƒˆç”¨ç§’æ•°
                        distText: dRes.distance ? dRes.distance.text : '--'
                    },
                    transit: {
                        status: tRes.status,
                        text: tRes.duration ? tRes.duration.text : '--',
                        distText: tRes.distance ? tRes.distance.text : '--'
                    }
                };
            });

            // ã‚½ãƒ¼ãƒˆï¼ˆè»Šã®æ‰€è¦æ™‚é–“ãŒçŸ­ã„é †ï¼‰
            // â€»è·é›¢é †ãŒã„ã„å ´åˆã¯ driving.distValue ãªã©ã‚’å–å¾—ã—ã¦æ¯”è¼ƒã—ã¦ãã ã•ã„
            calculatedStores.sort((a, b) => a.driving.value - b.driving.value);

            // è¡¨ç¤ºç”¨ãƒªã‚¹ãƒˆã®ä½œæˆãƒ­ã‚¸ãƒƒã‚¯
            // ãƒ«ãƒ¼ãƒ«: TOP5ã‚’è¡¨ç¤ºã™ã‚‹ãŒã€ãã®ä¸­ã«ç¾½ç”°ãŒå«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°è¿½åŠ ã™ã‚‹
            let displayList = calculatedStores.slice(0, 5);
            
            // ç¾½ç”°ãŒTOP5ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            const hasHaneda = displayList.some(s => s.id === 'haneda');

            if (!hasHaneda) {
                // å«ã¾ã‚Œã¦ã„ãªã„å ´åˆã€ç¾½ç”°ã‚’æ¢ã—ã¦ãƒªã‚¹ãƒˆã®æœ«å°¾ã«è¿½åŠ 
                const hanedaObj = calculatedStores.find(s => s.id === 'haneda');
                if (hanedaObj) {
                    displayList.push(hanedaObj);
                }
            }

            // ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
            renderCards(displayList);

            document.getElementById('results-area').style.display = 'block';

        } catch (error) {
            console.error(error);
            alert("è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½æ‰€ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        } finally {
            document.querySelector('.search-btn').disabled = false;
            document.getElementById('loader').style.display = 'none';
        }
    }

    // Distance Matrix APIã‚’PromiseåŒ–ã—ã¦ä½¿ã„ã‚„ã™ãã™ã‚‹é–¢æ•°
    function getDistanceMatrix(origin, destinations, mode) {
        return new Promise((resolve, reject) => {
            distanceMatrixService.getDistanceMatrix({
                origins: [origin],
                destinations: destinations,
                travelMode: google.maps.TravelMode[mode],
                unitSystem: google.maps.UnitSystem.METRIC,
            }, (response, status) => {
                if (status === 'OK') {
                    resolve(response);
                } else {
                    reject(status);
                }
            });
        });
    }

    function renderCards(stores) {
        const container = document.getElementById('cards-container');
        
        stores.forEach((store, index) => {
            const isHaneda = (store.id === 'haneda');
            const card = document.createElement('div');
            
            // ç¾½ç”°ã‚’ç›®ç«‹ãŸã›ã‚‹ã‚¯ãƒ©ã‚¹ä»˜ä¸
            card.className = `store-card ${isHaneda ? 'highlight' : ''}`;
            
            let badgeHtml = '';
            if (isHaneda) {
                badgeHtml = `<span class="badge">ç¾½ç”°ç©ºæ¸¯åº—</span>`;
            } else if (index === 0) {
                badgeHtml = `<span class="badge" style="background:#dc3545; color:white;">æœ€å¯„ã‚ŠNo.1</span>`;
            }

            // ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ï¼ˆåˆ°é”ä¸èƒ½ãªå ´åˆãªã©ï¼‰
            const dTime = store.driving.status === 'OK' ? store.driving.text : 'çµŒè·¯ãªã—';
            const dDist = store.driving.status === 'OK' ? store.driving.distText : '-';
            
            const tTime = store.transit.status === 'OK' ? store.transit.text : 'çµŒè·¯ãªã—';
            const tDist = store.transit.status === 'OK' ? store.transit.distText : '-';

            card.innerHTML = `
                ${badgeHtml}
                <div class="store-name">${store.name}</div>
                <div class="store-address">${store.address}</div>
                
                <div class="routes-grid">
                    <div class="route-info">
                        <div class="route-icon">ğŸš—</div>
                        <div class="route-time" style="${store.driving.status !== 'OK' ? 'font-size:12px;color:#aaa;' : ''}">${dTime}</div>
                        <div class="route-dist">${dDist}</div>
                    </div>
                    <div class="route-info">
                        <div class="route-icon">ğŸšƒ</div>
                        <div class="route-time" style="${store.transit.status !== 'OK' ? 'font-size:12px;color:#aaa;' : ''}">${tTime}</div>
                        <div class="route-dist">${tDist}</div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }
</script>

</body>
</html>
