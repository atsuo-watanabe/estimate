<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒšãƒƒãƒˆã‚¿ã‚¯ã‚·ãƒ¼æ–™é‡‘è¨ˆç®—ï¼ˆæ—¥æ™‚æŒ‡å®šç‰ˆï¼‰</title>
    <style>
        :root {
            --primary-color: #FF8C00;
            --primary-dark: #E67E00;
            --bg-color: #FFF5E6;
            --text-color: #333;
            --card-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --danger-color: #ff4d4d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px 15px;
            line-height: 1.6;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 25px 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px var(--shadow-color);
        }

        h1 {
            text-align: center;
            color: var(--text-color);
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        h1 span { font-size: 32px; }

        /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f5f5f5;
            padding: 5px;
            border-radius: 12px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            font-weight: bold;
            color: #888;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }
        .tab-btn.active {
            background: #fff;
            color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .form-group { margin-bottom: 20px; }
        label { font-weight: 600; display: block; margin-bottom: 8px; color: #555; font-size: 14px; }

        /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        select, input[type="text"], input[type="number"], input[type="datetime-local"] {
            width: 100%;
            padding: 14px;
            border: 2px solid #eee;
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s;
            -webkit-appearance: none;
            background-color: #fafafa;
            font-family: inherit;
        }
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: #fff;
        }

        /* çµŒç”±åœ°ã‚¨ãƒªã‚¢ */
        .waypoint-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            animation: fadeIn 0.3s ease;
        }
        .remove-btn {
            background: #ffecec;
            color: var(--danger-color);
            border: 1px solid #ffcccc;
            border-radius: 8px;
            width: 44px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            flex-shrink: 0;
        }
        .add-waypoint-btn {
            background: none;
            border: 2px dashed #ddd;
            color: #666;
            width: 100%;
            padding: 10px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: 0.2s;
        }
        .add-waypoint-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background-color: #fff8e1;
            border-radius: 12px;
            border: 2px solid #ffe0b2;
            cursor: pointer;
            transition: 0.2s;
        }
        .checkbox-wrapper:active { transform: scale(0.98); }
        .checkbox-wrapper input {
            margin-right: 15px;
            transform: scale(1.5);
            accent-color: var(--primary-color);
            cursor: pointer;
        }
        .checkbox-wrapper label {
            margin: 0;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            color: var(--primary-dark);
            flex: 1; 
        }
        .discount-badge {
            background: #ff4d4d;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
            white-space: nowrap;
        }

        .checkbox-avoid {
            background-color: #f0f4c3;
            border-color: #dce775;
        }
        .checkbox-avoid label {
            color: #558b2f;
        }
        .checkbox-avoid input {
            accent-color: #7cb342;
        }

        button.calc-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(230, 126, 0, 0.3);
            margin-top: 10px;
        }
        button.calc-btn:active { transform: scale(0.98); }

        /* çµæœã‚¨ãƒªã‚¢ */
        .result-box {
            background-color: #FFF0E0;
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            display: none;
            border-left: 5px solid var(--primary-color);
        }
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .result-item {
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }
        .result-label { font-size: 12px; color: #777; display: block; margin-bottom: 5px; }
        .result-value { font-size: 18px; font-weight: bold; }

        .price-container {
            text-align: center;
            padding-top: 15px;
            border-top: 2px dashed #ddd;
        }
        .price {
            font-size: 36px;
            font-weight: 800;
            color: var(--primary-dark);
            line-height: 1.2;
        }
        .price span { font-size: 20px; }
        .note { font-size: 12px; color: #888; margin-top: 10px; text-align: center; }

        #map {
            height: 250px;
            width: 100%;
            margin-top: 30px;
            border-radius: 15px;
            display: none;
        }
        .hidden { display: none; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pac-container {
            border-radius: 0 0 10px 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-top: none;
            font-family: inherit;
        }
    </style>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCH7MD4Jj8pKU9hDSJUYqBgq8fQsMWWDjE&libraries=places"></script>
</head>
<body>

<div class="container">
    <h1><span>ğŸˆ</span> ãƒšãƒƒãƒˆã‚¿ã‚¯ã‚·ãƒ¼æ–™é‡‘</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('map')">ä½æ‰€ã‹ã‚‰æ¤œç´¢</button>
        <button class="tab-btn" onclick="switchTab('manual')">è·é›¢å…¥åŠ›</button>
    </div>

    <div id="mode-map">
        <div class="form-group">
            <label for="origin-select">åº—èˆ—å</label>
            <div class="select-wrapper">
                <select id="origin-select" onchange="toggleOriginInput()">
                    <option value="minato">ã­ã“ã¹ã‚„æ¸¯åŒºæœ¬åº—</option>
                    <option value="haneda">ã­ã“ã¹ã‚„ç¾½ç”°ç©ºæ¸¯åº—</option>
                    <option value="suginami">ã­ã“ã¹ã‚„æ‰ä¸¦åº—</option>
                    <option value="musashino">ã­ã“ã¹ã‚„æ­¦è”µé‡åº—</option>
                    <option value="edogawa">ã­ã“ã¹ã‚„æ±Ÿæˆ¸å·åº—</option>
                    <option value="other">ãã®ä»–ï¼ˆä½æ‰€å…¥åŠ›ï¼‰</option>
                </select>
            </div>
            
            <div id="origin-custom-container" style="display: none; margin-top: 10px;">
                <input type="text" id="origin-custom" placeholder="å‡ºç™ºåœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
            </div>
        </div>

        <div id="waypoints-container"></div>
        <button type="button" class="add-waypoint-btn" onclick="addWaypoint()">ï¼‹ çµŒç”±åœ°ã‚’è¿½åŠ ã™ã‚‹</button>

        <div class="form-group">
            <label for="destination">ãŠå®¢æ§˜ä½æ‰€ (ç›®çš„åœ°)</label>
            <input type="text" id="destination" placeholder="ä½æ‰€ã¾ãŸã¯æ–½è¨­åã‚’å…¥åŠ›">
        </div>

        <div class="form-group">
            <label for="dept-time">å‡ºç™ºæ—¥æ™‚ (ä»»æ„)</label>
            <input type="datetime-local" id="dept-time">
            <p style="font-size:12px; color:#666; margin-top:5px;">â€»æ—¥æ™‚ã‚’æŒ‡å®šã™ã‚‹ã¨æ¸‹æ»äºˆæ¸¬ã‚’è€ƒæ…®ã—ãŸæ™‚é–“ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
        </div>
    </div>

    <div id="mode-manual" class="hidden">
        <div class="form-group">
            <label for="manual-dist">è·é›¢ (km)</label>
            <input type="number" id="manual-dist" placeholder="ä¾‹ï¼š15.5" step="0.1">
            <p style="font-size:12px; color:#888; margin-top:5px;">â€»Googleãƒãƒƒãƒ—ã‚’ä½¿ã‚ãšã€è·é›¢ã ã‘ã§è¨ˆç®—ã—ã¾ã™ã€‚</p>
        </div>
    </div>

    <div class="checkbox-wrapper checkbox-avoid" onclick="toggleCheckbox('avoid-tolls')">
        <input type="checkbox" id="avoid-tolls">
        <label for="avoid-tolls">
            æœ‰æ–™é“è·¯ã‚’ä½¿ã‚ãªã„ï¼ˆè·é›¢å„ªå…ˆï¼‰
        </label>
    </div>

    <div class="checkbox-wrapper" onclick="toggleCheckbox('round-trip')">
        <input type="checkbox" id="round-trip">
        <label for="round-trip">
            å¾€å¾©ã§åˆ©ç”¨ã™ã‚‹
            <span class="discount-badge">10% OFF</span>
        </label>
    </div>

    <button class="calc-btn" onclick="startCalculation()">æ–™é‡‘ã‚’è¨ˆç®—ã™ã‚‹</button>

    <div id="result" class="result-box">
        <div class="result-grid">
            <div class="result-item">
                <span class="result-label">ç·èµ°è¡Œè·é›¢</span>
                <span id="dist-text" class="result-value">--</span>
            </div>
            <div class="result-item">
                <span class="result-label">æ‰€è¦æ™‚é–“ <span id="time-note" style="font-weight:normal; font-size:10px;"></span></span>
                <span id="dur-text" class="result-value">--</span>
            </div>
        </div>
        <div class="price-container">
            <span class="price-label">æ¦‚ç®—æ–™é‡‘ï¼ˆç¨è¾¼ï¼‰</span>
            <span id="price-text" class="price">--<span>å††</span></span>
            <div id="round-trip-tag" style="display:none; color:#d32f2f; font-weight:bold; font-size:14px; margin-top:5px;">
                ğŸ‰ å¾€å¾©å‰²å¼•(10%OFF) é©ç”¨æ¸ˆã¿
            </div>
        </div>
        <p class="note">â€»ç‰‡é“ï¼šåˆä¹—ã‚Š3kmã¾ã§1,650å††ã€ä»¥é™1kmã”ã¨ã«550å††ï¼ˆç«¯æ•°åˆ‡ä¸Šï¼‰</p>
    </div>

    <div id="map"></div>
</div>

<script>
    let map;
    let directionsService;
    let directionsRenderer;
    let currentMode = 'map';

    // ç™»éŒ²åœ°ã®ä½æ‰€å®šç¾©
    const STORE_ADDRESSES = {
        'minato': 'æ±äº¬éƒ½æ¸¯åŒºèŠ3ä¸ç›®13-5',
        'haneda': 'æ±äº¬éƒ½å¤§ç”°åŒºç¾½ç”°1-8-4',
        'suginami': 'æ±äº¬éƒ½æ‰ä¸¦åŒºå®®å‰4ä¸ç›®25-28',
        'musashino': 'æ±äº¬éƒ½æ­¦è”µé‡å¸‚é–¢å‰4-11-25',
        'edogawa': 'æ±äº¬éƒ½æ±Ÿæˆ¸å·åŒºæ–°å €1ä¸ç›®24-1'
    };

    function initMap() {
        const tokyo = { lat: 35.6895, lng: 139.6917 };
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 10,
            center: tokyo,
            mapTypeControl: false,
            streetViewControl: false
        });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);

        setupAutocomplete(document.getElementById("destination"));
        setupAutocomplete(document.getElementById("origin-custom"));
    }

    function setupAutocomplete(inputElement) {
        const options = {
            componentRestrictions: { country: "jp" },
            fields: ["formatted_address", "geometry", "name"],
        };
        new google.maps.places.Autocomplete(inputElement, options);
    }

    window.onload = initMap;

    function toggleOriginInput() {
        const select = document.getElementById("origin-select");
        const customContainer = document.getElementById("origin-custom-container");
        
        if (select.value === "other") {
            customContainer.style.display = "block";
            document.getElementById("origin-custom").focus();
        } else {
            customContainer.style.display = "none";
        }
    }

    function switchTab(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        if (mode === 'map') {
            document.getElementById('mode-map').classList.remove('hidden');
            document.getElementById('mode-manual').classList.add('hidden');
            document.getElementById('map').style.display = 'block';
        } else {
            document.getElementById('mode-map').classList.add('hidden');
            document.getElementById('mode-manual').classList.remove('hidden');
            document.getElementById('map').style.display = 'none';
        }
        document.getElementById("result").style.display = "none";
    }

    function addWaypoint() {
        const container = document.getElementById('waypoints-container');
        const div = document.createElement('div');
        div.className = 'waypoint-item';
        
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'waypoint-input';
        input.placeholder = 'çµŒç”±åœ°ã‚’å…¥åŠ›';
        
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'remove-btn';
        btn.innerText = 'Ã—';
        btn.onclick = function() { div.remove(); };

        div.appendChild(input);
        div.appendChild(btn);
        container.appendChild(div);

        setupAutocomplete(input);
    }

    function toggleCheckbox(id) {
        if (event.target.tagName !== 'INPUT' && event.target.tagName !== 'LABEL') {
            const chk = document.getElementById(id);
            chk.checked = !chk.checked;
        }
    }

    function startCalculation() {
        if (currentMode === 'map') {
            calculateByMap();
        } else {
            calculateByManual();
        }
    }

    function calculateByMap() {
        const selectVal = document.getElementById("origin-select").value;
        let origin = "";

        if (selectVal === "other") {
            origin = document.getElementById("origin-custom").value;
            if (!origin) {
                alert("å‡ºç™ºåœ°ã®ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
        } else {
            origin = STORE_ADDRESSES[selectVal];
        }

        const destination = document.getElementById("destination").value;
        const avoidTolls = document.getElementById("avoid-tolls").checked;
        const timeInput = document.getElementById("dept-time").value; // æ—¥æ™‚å…¥åŠ›å€¤
        
        const waypointInputs = document.querySelectorAll('.waypoint-input');
        const waypoints = [];
        waypointInputs.forEach(input => {
            if (input.value.trim() !== "") {
                waypoints.push({
                    location: input.value,
                    stopover: true
                });
            }
        });

        if (!destination) {
            alert("ãŠå±Šã‘å…ˆä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
        const request = {
            origin: origin,
            destination: destination,
            waypoints: waypoints,
            optimizeWaypoints: true,
            avoidTolls: avoidTolls,
            travelMode: 'DRIVING',
            unitSystem: google.maps.UnitSystem.METRIC
        };

        // â˜…æ—¥æ™‚æŒ‡å®šãŒã‚ã‚‹å ´åˆã®å‡¦ç†
        let isPredicted = false;
        if (timeInput) {
            const departureDate = new Date(timeInput);
            const now = new Date();
            
            // éå»ã®æ—¥æ™‚ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€å°‘ã—ä½™è£•ã‚’è¦‹ã¦åˆ¤å®š
            if (departureDate < now) {
                // éå»ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆç¾åœ¨æ™‚åˆ»ã§è¨ˆç®—ï¼‰
                // å³å¯†ã«ã—ãŸã„å ´åˆã¯ alert("æœªæ¥ã®æ—¥æ™‚ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"); return; ã§ã‚‚å¯
            } else {
                request.drivingOptions = {
                    departureTime: departureDate,
                    trafficModel: 'best_guess' // æ¸‹æ»äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«
                };
                isPredicted = true;
            }
        }

        directionsService.route(request, function(result, status) {
            if (status == 'OK') {
                directionsRenderer.setDirections(result);
                document.getElementById('map').style.display = 'block';
                
                let totalDistanceMeters = 0;
                let totalDurationSeconds = 0;
                const legs = result.routes[0].legs;
                
                legs.forEach(leg => {
                    totalDistanceMeters += leg.distance.value;
                    // â˜…æ¸‹æ»äºˆæ¸¬æ™‚é–“ãŒã‚ã‚Œã°ãã¡ã‚‰(duration_in_traffic)ã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°é€šå¸¸æ™‚é–“(duration)
                    if (leg.duration_in_traffic) {
                        totalDurationSeconds += leg.duration_in_traffic.value;
                    } else {
                        totalDurationSeconds += leg.duration.value;
                    }
                });

                const distanceKm = totalDistanceMeters / 1000;
                const distanceText = (distanceKm).toFixed(1) + " km";
                
                const hours = Math.floor(totalDurationSeconds / 3600);
                const minutes = Math.floor((totalDurationSeconds % 3600) / 60);
                let durationText = "";
                if (hours > 0) durationText += hours + "æ™‚é–“ ";
                durationText += minutes + "åˆ†";

                // äºˆæ¸¬ã‹ã©ã†ã‹ã®ãƒ©ãƒ™ãƒ«æ›´æ–°
                const timeNote = document.getElementById("time-note");
                if (isPredicted) {
                    timeNote.innerText = "(æ¸‹æ»äºˆæ¸¬å«ã‚€)";
                    timeNote.style.color = "#d32f2f";
                } else {
                    timeNote.innerText = "";
                }

                displayFinalPrice(distanceKm, distanceText, durationText);
            } else {
                alert("ãƒ«ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: " + status);
            }
        });
    }

    function calculateByManual() {
        const distInput = document.getElementById("manual-dist").value;
        if (!distInput || distInput <= 0) {
            alert("æœ‰åŠ¹ãªè·é›¢(km)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        const distanceKm = parseFloat(distInput);
        document.getElementById("time-note").innerText = "";
        displayFinalPrice(distanceKm, distanceKm + " km", "--");
    }

    function displayFinalPrice(distanceKm, distText, durText) {
        let price = 0;
        const baseFare = 1650;
        const addFare = 550;

        if (distanceKm <= 3) {
            price = baseFare;
        } else {
            const extraDist = distanceKm - 3;
            const extraUnit = Math.ceil(extraDist); 
            price = baseFare + (extraUnit * addFare);
        }

        const isRoundTrip = document.getElementById('round-trip').checked;
        if (isRoundTrip) {
            price = (price * 2) * 0.9;
            price = Math.floor(price);
            document.getElementById('round-trip-tag').style.display = 'block';
        } else {
            document.getElementById('round-trip-tag').style.display = 'none';
        }

        document.getElementById("dist-text").innerText = distText;
        document.getElementById("dur-text").innerText = durText;
        document.getElementById("price-text").innerHTML = price.toLocaleString() + "<span>å††</span>";
        
        const resultBox = document.getElementById("result");
        resultBox.style.display = "block";
        resultBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
</script>

</body>
</html>
